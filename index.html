<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مشجر التحورات الجينية</title>
  <style>
    /* تنسيق عام للصناديق */
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    .tree-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .mutation-box {
      border: 2px solid #333;
      padding: 10px;
      margin: 10px 0;
      text-align: center;
      background-color: #f9f9f9;
      width: 200px;
    }

    .sample-container {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }

    .sample {
      background-color: #ddd;
      padding: 5px;
      margin: 5px;
      border-radius: 5px;
      font-size: 12px;
    }

    .branch-line {
      width: 2px;
      height: 20px;
      background-color: #333;
      margin: 0 auto;
    }
  </style>
</head>
<body>

  <div id="tree-container" class="tree-container"></div>

  <script>
    // الدالة لجلب البيانات من ملف CSV
    async function fetchCSVData(url) {
      const response = await fetch(url);
      const data = await response.text();
      const parsedData = d3.csvParse(data);
      return parsedData;
    }

    // تحويل البيانات إلى هيكل الشجرة
    function processTreeData(data) {
      const root = { name: 'J', children: [] };

      data.forEach(({ personInfo, locationInfo, mutationInfo }) => {
        const mutationArray = mutationInfo.split('>');
        let currentNode = root;

        mutationArray.forEach((mutation, index) => {
          let existingNode = currentNode.children.find(child => child.name === mutation);
          if (!existingNode) {
            existingNode = { name: mutation, children: [] };
            currentNode.children.push(existingNode);
          }
          currentNode = existingNode;
          if (index === mutationArray.length - 1) {
            if (!currentNode.samples) currentNode.samples = [];
            currentNode.samples.push({ name: personInfo, location: locationInfo });
          }
        });
      });

      return root;
    }

    // رسم شجرة التحورات بشكل عمودي
    function drawTree(treeData) {
      const container = document.getElementById('tree-container');

      function createMutationBox(node) {
        const mutationBox = document.createElement('div');
        mutationBox.className = 'mutation-box';
        mutationBox.innerHTML = `<strong>${node.name}</strong>`;

        // إضافة العينات أسفل كل تحور
        if (node.samples) {
          const sampleContainer = document.createElement('div');
          sampleContainer.className = 'sample-container';
          node.samples.forEach(sample => {
            const sampleDiv = document.createElement('div');
            sampleDiv.className = 'sample';
            sampleDiv.textContent = `${sample.name} (${sample.location})`;
            sampleContainer.appendChild(sampleDiv);
          });
          mutationBox.appendChild(sampleContainer);
        }

        return mutationBox;
      }

      function drawNode(node) {
        const mutationBox = createMutationBox(node);
        container.appendChild(mutationBox);

        // رسم خط الفروع العمودي
        if (node.children.length > 0) {
          const branchLine = document.createElement('div');
          branchLine.className = 'branch-line';
          container.appendChild(branchLine);

          // رسم كل طفل بشكل متكرر
          node.children.forEach(child => drawNode(child));
        }
      }

      drawNode(treeData);
    }

    // الرابط للملف CSV
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRnDqmeMrSFgOBL5MHbulxNw7F9PO4PZBFXtBqEyPmiljTZWQCTwakxKiRneckhvknl-jpvOeR7PuJT/pub?output=csv';

    // استدعاء الدالة لجلب البيانات ورسم الشجرة
    fetchCSVData(csvUrl).then(data => {
      const treeData = processTreeData(data);
      drawTree(treeData);
    });
  </script>

</body>
</html>
