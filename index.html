<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genetic Mutations Tree</title>
    <style>
        /* Add some basic styles for the tree */
        .node {
            cursor: pointer;
        }
        .node:hover {
            stroke: #ff5733;
            stroke-width: 2px;
        }
        .label {
            font-size: 12px;
        }
        svg {
            font: 10px sans-serif;
        }
        text {
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="tree"></div>

    <!-- Load D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Load CSV data from Google Sheets
            Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vRnDqmeMrSFgOBL5MHbulxNw7F9PO4PZBFXtBqEyPmiljTZWQCTwakxKiRneckhvknl-jpvOeR7PuJT/pub?output=csv', {
                download: true,
                header: true,
                complete: function(results) {
                    const data = results.data;
                    const treeData = buildTreeData(data);
                    drawTree(treeData);
                },
                error: function(error) {
                    console.error('Error loading CSV data:', error);
                }
            });

            function buildTreeData(data) {
                // Create a hierarchical tree structure based on the data
                let tree = { name: 'j', children: [] };
                let nodes = {};
                nodes['j'] = tree;

                data.forEach(row => {
                    if (!row['mutationInfo']) return; // Skip rows without mutations
                    const mutations = row['mutationInfo'].split('>');
                    let currentNode = nodes['j'];

                    mutations.forEach(mutation => {
                        if (!nodes[mutation]) {
                            nodes[mutation] = { name: mutation, children: [], samples: [] };
                            currentNode.children.push(nodes[mutation]);
                        }
                        currentNode = nodes[mutation];
                    });
                    currentNode.samples.push({ name: row['personInfo'], location: row['locationInfo'] });
                });

                return tree;
            }

            function drawTree(treeData) {
                const width = 960;
                const height = 600;

                const svg = d3.select('#tree').append('svg')
                    .attr('width', width)
                    .attr('height', height);

                const root = d3.hierarchy(treeData);
                const treeLayout = d3.tree().size([height, width - 160]);
                treeLayout(root);

                svg.selectAll('line.link')
                    .data(root.descendants().slice(1))
                    .enter().append('line')
                    .attr('class', 'link')
                    .attr('x1', d => d.y)
                    .attr('y1', d => d.x)
                    .attr('x2', d => d.parent.y)
                    .attr('y2', d => d.parent.x);

                const node = svg.selectAll('g.node')
                    .data(root.descendants())
                    .enter().append('g')
                    .attr('class', 'node')
                    .attr('transform', d => `translate(${d.y},${d.x})`);

                node.append('circle')
                    .attr('r', 5)
                    .style('fill', '#ff5733');

                node.append('text')
                    .attr('dy', 3)
                    .attr('x', d => d.children ? -10 : 10)
                    .style('text-anchor', d => d.children ? 'end' : 'start')
                    .text(d => d.data.name);

                // Add samples information
                node.append('title')
                    .text(d => {
                        if (!d.data.samples) return '';
                        return d.data.samples.map(s => `${s.name} (${s.location})`).join('\n');
                    });
            }
        });
    </script>
</body>
</html>
