<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مشجر التحورات الجينية</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/treant-js@1.0.0/treant.min.css">
  <style>
    /* تنسيقات مخصصة لجعل الشجرة تناسب العرض */
    #tree-container {
      width: 100%;
      height: 600px;
    }
  </style>
</head>
<body>
  <div id="tree-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/treant-js@1.0.0/raphael.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/treant-js@1.0.0/treant.min.js"></script>
  <script>
    // الدالة لجلب البيانات من ملف CSV
    async function fetchCSVData(url) {
      const response = await fetch(url);
      const data = await response.text();
      const parsedData = d3.csvParse(data);
      return parsedData;
    }

    // تحويل البيانات إلى هيكل الشجرة لـ Treant.js
    function processTreeData(data) {
      const nodes = [];
      const links = [];

      // إنشاء العقدة الجذرية
      const root = { name: 'J', children: [] };
      const nodeMap = { 'J': root };

      // معالجة البيانات وإنشاء العقد والفروع
      data.forEach(({ personInfo, locationInfo, mutationInfo }) => {
        // استبدال علامات "أكبر من" بفواصل
        const mutationArray = mutationInfo.replace(/ > /g, ' > ').split(' > ');
        let currentNode = root;

        mutationArray.forEach((mutation, index) => {
          if (!nodeMap[mutation]) {
            nodeMap[mutation] = { name: mutation, children: [] };
            currentNode.children.push(nodeMap[mutation]);
          }
          currentNode = nodeMap[mutation];
          if (index === mutationArray.length - 1) {
            if (!currentNode.samples) currentNode.samples = [];
            currentNode.samples.push({ name: personInfo, location: locationInfo });
          }
        });
      });

      function convertToTreantFormat(node) {
        const treantNode = { text: { name: node.name }, children: [] };
        if (node.samples) {
          treantNode.text.name += `<br>${node.samples.map(s => `${s.name} (${s.location})`).join('<br>')}`;
        }
        node.children.forEach(child => treantNode.children.push(convertToTreantFormat(child)));
        return treantNode;
      }

      return convertToTreantFormat(root);
    }

    // رسم شجرة التحورات باستخدام Treant.js
    function drawTree(treeData) {
      new Treant({
        chart: {
          container: "#tree-container",
          node: {
            HTMLclass: "nodeExample1"
          }
        },
        nodeStructure: treeData
      });
    }

    // الرابط للملف CSV
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRnDqmeMrSFgOBL5MHbulxNw7F9PO4PZBFXtBqEyPmiljTZWQCTwakxKiRneckhvknl-jpvOeR7PuJT/pub?output=csv';

    // استدعاء الدالة لجلب البيانات ورسم الشجرة
    fetchCSVData(csvUrl).then(data => {
      const treeData = processTreeData(data);
      drawTree(treeData);
    });
  </script>
</body>
</html>
