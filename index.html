<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genetic Mutations Tree</title>
    <style>
        /* Basic styles for the tree */
        .node {
            cursor: pointer;
        }
        .node:hover {
            stroke: #2ecc71;
            stroke-width: 2px;
        }
        .label {
            font-size: 12px;
            text-anchor: middle;
        }
        svg {
            font: 12px sans-serif;
        }
        .link {
            stroke: #3498db;
            stroke-width: 2px;
        }
        circle {
            fill: #e74c3c;
            stroke: #c0392b;
            stroke-width: 2px;
        }
        /* Container for the SVG */
        #tree {
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="tree"></div>

    <!-- Load D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Load CSV data from Google Sheets
            Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vRnDqmeMrSFgOBL5MHbulxNw7F9PO4PZBFXtBqEyPmiljTZWQCTwakxKiRneckhvknl-jpvOeR7PuJT/pub?output=csv', {
                download: true,
                header: true,
                complete: function(results) {
                    const data = results.data;
                    const treeData = buildTreeData(data);
                    drawTree(treeData);
                },
                error: function(error) {
                    console.error('Error loading CSV data:', error);
                }
            });

            function buildTreeData(data) {
                let tree = { name: 'j', children: [] };
                let nodes = {};
                nodes['j'] = tree;

                data.forEach(row => {
                    if (!row['mutationInfo']) return; // Skip rows without mutations
                    const mutations = row['mutationInfo'].split('>');
                    let currentNode = nodes['j'];

                    mutations.forEach(mutation => {
                        if (!nodes[mutation]) {
                            nodes[mutation] = { name: mutation, children: [], samples: [] };
                            currentNode.children.push(nodes[mutation]);
                        }
                        currentNode = nodes[mutation];
                    });
                    currentNode.samples.push({ name: row['personInfo'], location: row['locationInfo'] });
                });

                return tree;
            }

            function drawTree(treeData) {
                const svg = d3.select('#tree').append('svg')
                    .attr('width', '100%')
                    .attr('height', '100%')
                    .append('g');

                const root = d3.hierarchy(treeData);
                const treeLayout = d3.tree().nodeSize([60, 180]); // Adjust node size and spacing
                treeLayout(root);

                // Get dimensions of the tree layout
                const { x: rootX, y: rootY } = root;
                const treeWidth = d3.max(root.descendants(), d => d.x) + 100; // Add margin
                const treeHeight = d3.max(root.descendants(), d => d.y) + 100; // Add margin

                // Set the SVG dimensions and translate the tree to center
                svg.attr('width', treeWidth)
                   .attr('height', treeHeight)
                   .attr('transform', `translate(${treeWidth / 2}, ${treeHeight / 2})`);

                // Draw links
                svg.selectAll('line.link')
                    .data(root.descendants().slice(1))
                    .enter().append('line')
                    .attr('class', 'link')
                    .attr('x1', d => d.x - treeWidth / 2)
                    .attr('y1', d => d.y - treeHeight / 2)
                    .attr('x2', d => d.parent.x - treeWidth / 2)
                    .attr('y2', d => d.parent.y - treeHeight / 2);

                // Draw nodes
                const node = svg.selectAll('g.node')
                    .data(root.descendants())
                    .enter().append('g')
                    .attr('class', 'node')
                    .attr('transform', d => `translate(${d.x - treeWidth / 2},${d.y - treeHeight / 2})`);

                node.append('circle')
                    .attr('r', 6);

                node.append('text')
                    .attr('dy', 3)
                    .attr('y', 15)
                    .text(d => d.data.name)
                    .attr('class', 'label');

                // Add samples information
                node.append('title')
                    .text(d => {
                        if (!d.data.samples) return '';
                        return d.data.samples.map(s => `${s.name} (${s.location})`).join('\n');
                    });

                // Zoom and pan settings
                const zoom = d3.zoom()
                    .scaleExtent([0.5, 2]) // Min and max zoom levels
                    .translateExtent([[0, 0], [treeWidth, treeHeight]]) // Bounds for panning
                    .on("zoom", (event) => {
                        svg.attr("transform", event.transform);
                    });

                d3.select("svg").call(zoom);
            }
        });
    </script>
</body>
</html>
