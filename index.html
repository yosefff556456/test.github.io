<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genetic Mutations Tree</title>
    <style>
        /* Basic styles for the tree */
        .node {
            cursor: pointer;
            text-align: center;
        }
        .node:hover {
            stroke: #2ecc71;
            stroke-width: 2px;
        }
        .label {
            font-size: 12px;
            text-align: center;
        }
        svg {
            font: 12px sans-serif;
        }
        text {
            pointer-events: none;
        }
        .link {
            stroke: #3498db;
            stroke-width: 2px;
        }
        circle {
            fill: #e74c3c;
            stroke: #c0392b;
            stroke-width: 2px;
        }
        .mutation-title {
            font-weight: bold;
            fill: #2c3e50;
            background: #ecf0f1;
            padding: 5px;
            border-radius: 5px;
        }
        .mutation-sample {
            font-size: 10px;
            fill: #7f8c8d;
        }
        .mutation-info {
            display: inline-block;
            margin-left: 10px;
        }
        .mutation-container {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <div id="tree"></div>

    <!-- Load D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Load CSV data from Google Sheets
            Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vRnDqmeMrSFgOBL5MHbulxNw7F9PO4PZBFXtBqEyPmiljTZWQCTwakxKiRneckhvknl-jpvOeR7PuJT/pub?output=csv', {
                download: true,
                header: true,
                complete: function(results) {
                    const data = results.data;
                    const treeData = buildTreeData(data);
                    drawTree(treeData);
                },
                error: function(error) {
                    console.error('Error loading CSV data:', error);
                }
            });

            function buildTreeData(data) {
                let tree = { name: 'j', children: [] };
                let nodes = {};
                nodes['j'] = tree;

                data.forEach(row => {
                    if (!row['mutationInfo']) return; // Skip rows without mutations
                    const mutations = row['mutationInfo'].split('>');
                    let currentNode = nodes['j'];

                    mutations.forEach(mutation => {
                        if (!nodes[mutation]) {
                            nodes[mutation] = { name: mutation, children: [], samples: [], age: row['ageInfo'] };
                            currentNode.children.push(nodes[mutation]);
                        }
                        currentNode = nodes[mutation];
                    });
                    currentNode.samples.push({ name: row['personInfo'], location: row['locationInfo'] });
                });

                return tree;
            }

            function drawTree(treeData) {
                const width = 1200;
                const height = 800;
                const margin = { top: 20, right: 120, bottom: 20, left: 120 };

                const svg = d3.select('#tree').append('svg')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom)
                    .append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                const root = d3.hierarchy(treeData);
                const treeLayout = d3.tree().size([height, width - 200]);
                treeLayout(root);

                svg.selectAll('line.link')
                    .data(root.descendants().slice(1))
                    .enter().append('line')
                    .attr('class', 'link')
                    .attr('x1', d => d.y)
                    .attr('y1', d => d.x)
                    .attr('x2', d => d.parent.y)
                    .attr('y2', d => d.parent.x);

                const node = svg.selectAll('g.node')
                    .data(root.descendants())
                    .enter().append('g')
                    .attr('class', 'node')
                    .attr('transform', d => `translate(${d.y},${d.x})`);

                node.append('circle')
                    .attr('r', 6);

                node.append('rect')
                    .attr('x', -60)
                    .attr('y', -15)
                    .attr('width', 120)
                    .attr('height', 30)
                    .attr('class', 'mutation-title');

                node.append('text')
                    .attr('dy', 3)
                    .attr('x', 0)
                    .style('text-anchor', 'middle')
                    .attr('class', 'mutation-title')
                    .text(d => d.data.name);

                // Add samples information
                node.append('foreignObject')
                    .attr('x', 80)
                    .attr('y', -20)
                    .attr('width', 200)
                    .attr('height', 40)
                    .append('xhtml:div')
                    .attr('class', 'mutation-info')
                    .html(d => d.data.samples.map(s => `<span class="mutation-sample">${s.name} (${s.location})</span>`).join('<br>'));
            }
        });
    </script>
</body>
</html>
