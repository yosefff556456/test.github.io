<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مشجر التحورات الجينية</title>
  <style>
    /* تنسيق عام للصناديق */
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }

    .tree-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .mutation-box {
      border: 2px solid #333;
      padding: 10px;
      margin: 10px 0;
      text-align: center;
      background-color: #f9f9f9;
      width: 200px;
      position: relative;
    }

    .sample-container {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }

    .sample {
      background-color: #ddd;
      padding: 5px;
      margin: 5px;
      border-radius: 5px;
      font-size: 12px;
    }

    .branch-line {
      width: 2px;
      background-color: #333;
      margin: 0 auto;
      position: relative;
    }

    .branch-line::before {
      content: '';
      display: block;
      width: 0;
      height: 20px;
      border-left: 2px solid #333;
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
    }
  </style>
</head>
<body>

  <div id="tree-container" class="tree-container"></div>

  <script>
    // الدالة لجلب البيانات من ملف CSV
    async function fetchCSVData(url) {
      const response = await fetch(url);
      const data = await response.text();
      const parsedData = d3.csvParse(data);
      return parsedData;
    }

    // تحويل البيانات إلى هيكل الشجرة
    function processTreeData(data) {
      const root = { name: 'J', children: [] };

      data.forEach(({ personInfo, locationInfo, mutationInfo }) => {
        const mutationArray = mutationInfo.split('>').map(m => m.trim());
        let currentNode = root;

        mutationArray.forEach((mutation, index) => {
          let existingNode = currentNode.children.find(child => child.name === mutation);
          if (!existingNode) {
            existingNode = { name: mutation, children: [] };
            currentNode.children.push(existingNode);
          }
          currentNode = existingNode;
          if (index === mutationArray.length - 1) {
            if (!currentNode.samples) currentNode.samples = [];
            currentNode.samples.push({ name: personInfo, location: locationInfo });
          }
        });
      });

      return root;
    }

    // رسم شجرة التحورات بشكل عمودي
    function drawTree(treeData) {
      const container = document.getElementById('tree-container');

      function createMutationBox(node) {
        const mutationBox = document.createElement('div');
        mutationBox.className = 'mutation-box';
        mutationBox.innerHTML = `<strong>${node.name}</strong>`;

        // إضافة العينات أسفل كل تحور
        if (node.samples) {
          const sampleContainer = document.createElement('div');
          sampleContainer.className = 'sample-container';
          node.samples.forEach(sample => {
            const sampleDiv = document.createElement('div');
            sampleDiv.className = 'sample';
            sampleDiv.textContent = `${sample.name} (${sample.location})`;
            sampleContainer.appendChild(sampleDiv);
          });
          mutationBox.appendChild(sampleContainer);
        }

        return mutationBox;
      }

      function drawNode(node, parentElement) {
        const mutationBox = createMutationBox(node);
        parentElement.appendChild(mutationBox);

        if (node.children.length > 0) {
          const branchContainer = document.createElement('div');
          branchContainer.className = 'branch-line';
          parentElement.appendChild(branchContainer);

          node.children.forEach(child => {
            const childContainer = document.createElement('div');
            childContainer.style.display = 'flex';
            childContainer.style.flexDirection = 'column';
            childContainer.style.alignItems = 'center';
            childContainer.style.marginTop = '20px';
            parentElement.appendChild(childContainer);
            drawNode(child, childContainer);
          });
        }
      }

      drawNode(treeData, container);
    }

    // الرابط للملف CSV
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRnDqmeMrSFgOBL5MHbulxNw7F9PO4PZBFXtBqEyPmiljTZWQCTwakxKiRneckhvknl-jpvOeR7PuJT/pub?output=csv';

    // استدعاء الدالة لجلب البيانات ورسم الشجرة
    fetchCSVData(csvUrl).then(data => {
      const treeData = processTreeData(data);
      drawTree(treeData);
    });
  </script>

</body>
</html>
